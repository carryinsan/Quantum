<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumChat Pro | Decentralized Messenger</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- WebRTC Engine -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #000000;
            color: #e2e8f0;
            overflow: hidden;
        }

        /* Animations */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .glass-morphism {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- Fallback loading screen to prevent initial white screen -->
        <div class="h-screen w-screen flex items-center justify-center bg-black text-white">
            <div class="animate-pulse flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p>Initializing Quantum Core...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Error Boundary Component ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen flex items-center justify-center bg-red-950 text-white p-8 text-center">
                            <div>
                                <h1 className="text-3xl font-bold mb-4">‚ö†Ô∏è System Failure</h1>
                                <p className="mb-4">Something went wrong. Don't worry, your data is saved safely.</p>
                                <code className="bg-black p-2 rounded block mb-4 text-xs">{this.state.error.toString()}</code>
                                <button onClick={() => window.location.reload()} className="bg-white text-red-900 px-4 py-2 rounded font-bold">Restart System</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Utils ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatTime = (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // --- Main App ---
        function App() {
            // -- State: Identity & Connectivity --
            const [myPeerId, setMyPeerId] = useState("");
            const [myProfile, setMyProfile] = useState({ name: "Anonymous", avatar: "" });
            const [peer, setPeer] = useState(null);
            const [connections, setConnections] = useState({}); // { [peerId]: DataConnection }
            const [connectionStatus, setConnectionStatus] = useState("disconnected");
            
            // -- State: Data --
            const [chats, setChats] = useState({}); 
            const [activeChatId, setActiveChatId] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            
            // -- State: UI --
            const [msgInput, setMsgInput] = useState("");
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeModal, setActiveModal] = useState(null); // 'add-contact', 'rename', 'backup'
            const [typingStatus, setTypingStatus] = useState({}); // { [chatId]: boolean }
            const [onlineStatus, setOnlineStatus] = useState({}); // { [peerId]: boolean }

            // -- Refs --
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef({});
            const fileInputRef = useRef(null);
            const backupInputRef = useRef(null);

            // -- Initialization --
            useEffect(() => {
                // Load Data
                const savedChats = localStorage.getItem("quantum_chats_v2");
                const savedProfile = localStorage.getItem("quantum_profile_v2");
                
                if (savedChats) {
                    try { setChats(JSON.parse(savedChats)); } catch (e) { console.error("Corrupt chat data", e); }
                }
                if (savedProfile) {
                    try { setMyProfile(JSON.parse(savedProfile)); } catch (e) { console.error("Corrupt profile", e); }
                }

                // Init Icons
                lucide.createIcons();

                // Init PeerJS
                const newPeer = new Peer(undefined, {
                    debug: 1,
                    config: {
                         iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });

                newPeer.on('open', (id) => {
                    setMyPeerId(id);
                    setPeer(newPeer);
                    setConnectionStatus("connected");
                });

                newPeer.on('connection', handleIncomingConnection);
                
                newPeer.on('error', (err) => {
                    console.warn("PeerJS Error:", err);
                    if (err.type === 'peer-unavailable') alert("User not found or offline.");
                });

                newPeer.on('disconnected', () => setConnectionStatus("disconnected"));

                return () => newPeer.destroy();
            }, []);

            // -- Effects --
            useEffect(() => {
                localStorage.setItem("quantum_chats_v2", JSON.stringify(chats));
            }, [chats]);

            useEffect(() => {
                localStorage.setItem("quantum_profile_v2", JSON.stringify(myProfile));
            }, [myProfile]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [chats, activeChatId, typingStatus]);

            useEffect(() => {
                lucide.createIcons();
            }, [sidebarOpen, activeChatId, activeModal]);

            // -- Logic: Connection Handling --
            const handleIncomingConnection = (conn) => {
                conn.on('open', () => {
                    setConnections(prev => ({ ...prev, [conn.peer]: conn }));
                    setOnlineStatus(prev => ({ ...prev, [conn.peer]: true }));
                    
                    // Send my profile immediately
                    conn.send({ type: 'PROFILE_UPDATE', name: myProfile.name });

                    // Ensure chat exists
                    setChats(prev => {
                        if (prev[conn.peer]) return prev;
                        return {
                            ...prev,
                            [conn.peer]: {
                                id: conn.peer,
                                name: `User ${conn.peer.substr(0,4)}`,
                                type: 'direct',
                                messages: [],
                                unread: 0,
                                lastSeen: Date.now()
                            }
                        };
                    });
                });

                conn.on('data', (data) => handleData(conn.peer, data));
                
                conn.on('close', () => {
                    setOnlineStatus(prev => ({ ...prev, [conn.peer]: false }));
                });
                
                conn.on('error', () => {
                    setOnlineStatus(prev => ({ ...prev, [conn.peer]: false }));
                });
            };

            // -- Logic: Data Handling --
            const handleData = (senderId, data) => {
                if (data.type === 'CHAT') {
                    // Reset typing
                    setTypingStatus(prev => ({ ...prev, [senderId]: false }));
                    
                    const newMsg = {
                        id: Date.now(),
                        sender: 'them',
                        text: data.text,
                        image: data.image || null,
                        timestamp: Date.now()
                    };

                    setChats(prev => {
                        const chat = prev[senderId] || { id: senderId, name: 'Unknown', type: 'direct', messages: [] };
                        return {
                            ...prev,
                            [senderId]: {
                                ...chat,
                                messages: [...chat.messages, newMsg],
                                unread: activeChatId !== senderId ? (chat.unread || 0) + 1 : 0
                            }
                        };
                    });
                } 
                else if (data.type === 'TYPING') {
                    setTypingStatus(prev => ({ ...prev, [senderId]: data.isTyping }));
                    
                    // Auto clear typing status after 3s in case we miss the 'false' packet
                    if (data.isTyping) {
                        clearTimeout(typingTimeoutRef.current[senderId]);
                        typingTimeoutRef.current[senderId] = setTimeout(() => {
                            setTypingStatus(prev => ({ ...prev, [senderId]: false }));
                        }, 3000);
                    }
                }
                else if (data.type === 'PROFILE_UPDATE') {
                    setChats(prev => ({
                        ...prev,
                        [senderId]: { ...prev[senderId], name: data.name }
                    }));
                }
            };

            // -- Logic: User Actions --
            const connectToPeer = (targetId) => {
                if (!targetId || targetId === myPeerId) return;
                const conn = peer.connect(targetId);
                handleIncomingConnection(conn);
                setActiveChatId(targetId);
                setActiveModal(null);
            };

            const sendMessage = (text = "", image = null) => {
                if ((!text && !image) || !activeChatId) return;

                const conn = connections[activeChatId];
                if (conn && conn.open) {
                    conn.send({ type: 'CHAT', text, image });
                }

                const newMsg = {
                    id: Date.now(),
                    sender: 'me',
                    text,
                    image,
                    timestamp: Date.now()
                };

                setChats(prev => ({
                    ...prev,
                    [activeChatId]: {
                        ...prev[activeChatId],
                        messages: [...prev[activeChatId].messages, newMsg]
                    }
                }));

                setMsgInput("");
            };

            const handleTyping = (e) => {
                setMsgInput(e.target.value);
                if (activeChatId && connections[activeChatId]) {
                    connections[activeChatId].send({ type: 'TYPING', isTyping: true });
                    
                    // Debounce sending "stopped typing"
                    clearTimeout(typingTimeoutRef.current['me']);
                    typingTimeoutRef.current['me'] = setTimeout(() => {
                        if(connections[activeChatId]) 
                            connections[activeChatId].send({ type: 'TYPING', isTyping: false });
                    }, 1000);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validate size (limit to 500KB for PeerJS reliability)
                if (file.size > 500 * 1024) {
                    alert("Image too large. Please select an image under 500KB.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    sendMessage("", event.target.result);
                };
                reader.readAsDataURL(file);
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(chats));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `quantum_backup_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        setChats(prev => ({ ...prev, ...imported }));
                        alert("Chats imported successfully!");
                        setActiveModal(null);
                    } catch (err) {
                        alert("Invalid backup file.");
                    }
                };
                reader.readAsText(file);
            };

            const updateProfile = () => {
                // Broadcast new name to all connected peers
                Object.values(connections).forEach(conn => {
                    if (conn.open) conn.send({ type: 'PROFILE_UPDATE', name: myProfile.name });
                });
                setIsSettingsOpen(false);
            };

            // -- Logic: Filtering --
            const filteredChats = useMemo(() => {
                return Object.values(chats)
                    .filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                 c.messages.some(m => m.text.toLowerCase().includes(searchTerm.toLowerCase())))
                    .sort((a,b) => (b.messages[b.messages.length-1]?.timestamp || 0) - (a.messages[a.messages.length-1]?.timestamp || 0));
            }, [chats, searchTerm]);

            // -- Render Parts --
            const renderModal = () => {
                if (!activeModal) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-md p-6 relative shadow-2xl">
                            <button onClick={() => setActiveModal(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                                <i data-lucide="x"></i>
                            </button>

                            {activeModal === 'add' && (
                                <div>
                                    <h3 className="text-xl font-bold mb-4 text-indigo-400">Add New Connection</h3>
                                    <input type="text" id="connectId" placeholder="Paste User ID here..." className="w-full bg-slate-950 border border-slate-700 p-3 rounded-lg text-white mb-4 focus:ring-2 ring-indigo-500 outline-none" />
                                    <button onClick={() => connectToPeer(document.getElementById('connectId').value)} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-lg font-bold">Connect</button>
                                </div>
                            )}

                            {activeModal === 'backup' && (
                                <div>
                                    <h3 className="text-xl font-bold mb-4 text-emerald-400">Data Management</h3>
                                    <div className="space-y-4">
                                        <button onClick={handleExport} className="w-full bg-slate-800 border border-slate-700 hover:bg-slate-700 p-4 rounded-lg flex items-center justify-between group">
                                            <span>Export Chat History</span>
                                            <i data-lucide="download" className="text-slate-400 group-hover:text-emerald-400"></i>
                                        </button>
                                        <div className="relative">
                                            <input type="file" ref={backupInputRef} onChange={handleImport} className="hidden" accept=".json" />
                                            <button onClick={() => backupInputRef.current.click()} className="w-full bg-slate-800 border border-slate-700 hover:bg-slate-700 p-4 rounded-lg flex items-center justify-between group">
                                                <span>Import Chat History</span>
                                                <i data-lucide="upload" className="text-slate-400 group-hover:text-blue-400"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeModal === 'rename' && activeChatId && (
                                <div>
                                    <h3 className="text-xl font-bold mb-4 text-indigo-400">Rename Contact</h3>
                                    <input 
                                        type="text" 
                                        defaultValue={chats[activeChatId].name} 
                                        id="renameInput"
                                        className="w-full bg-slate-950 border border-slate-700 p-3 rounded-lg text-white mb-4" 
                                    />
                                    <button onClick={() => {
                                        const newName = document.getElementById('renameInput').value;
                                        setChats(prev => ({ ...prev, [activeChatId]: { ...prev[activeChatId], name: newName }}));
                                        setActiveModal(null);
                                    }} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-lg font-bold">Save Name</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex h-screen w-screen bg-slate-950 text-slate-200">
                    {/* Background Ambience */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                        <div className="absolute top-0 left-1/4 w-96 h-96 bg-indigo-900/20 rounded-full mix-blend-screen filter blur-3xl animate-blob"></div>
                        <div className="absolute top-0 right-1/4 w-96 h-96 bg-purple-900/20 rounded-full mix-blend-screen filter blur-3xl animate-blob animation-delay-2000"></div>
                    </div>

                    {/* Sidebar */}
                    <div className={`${sidebarOpen ? 'w-80 translate-x-0' : 'w-0 -translate-x-full md:w-20 md:translate-x-0'} z-20 flex flex-col bg-slate-900/80 backdrop-blur border-r border-slate-800 transition-all duration-300`}>
                        {/* Header */}
                        <div className="p-4 flex items-center justify-between border-b border-slate-800 h-16">
                            {sidebarOpen ? (
                                <div className="font-bold text-xl tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">
                                    QUANTUM
                                </div>
                            ) : (
                                <div className="mx-auto"><i data-lucide="zap" className="text-indigo-500"></i></div>
                            )}
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="text-slate-500 hover:text-white hidden md:block">
                                <i data-lucide={sidebarOpen ? "chevrons-left" : "chevrons-right"}></i>
                            </button>
                        </div>

                        {/* Search & Actions */}
                        {sidebarOpen && (
                            <div className="p-4 space-y-4">
                                <div className="relative">
                                    <i data-lucide="search" className="absolute left-3 top-2.5 w-4 h-4 text-slate-500"></i>
                                    <input 
                                        type="text" 
                                        placeholder="Search messages..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full bg-slate-950 border border-slate-800 rounded-lg pl-9 pr-3 py-2 text-sm focus:border-indigo-500 outline-none"
                                    />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setActiveModal('add')} className="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg text-sm font-medium transition-colors flex justify-center items-center gap-2">
                                        <i data-lucide="plus" className="w-4 h-4"></i> Add
                                    </button>
                                    <button onClick={() => setActiveModal('backup')} className="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 border border-slate-700">
                                        <i data-lucide="hard-drive-download" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Chat List */}
                        <div className="flex-1 overflow-y-auto px-2 space-y-1 py-2">
                            {filteredChats.map(chat => (
                                <div 
                                    key={chat.id}
                                    onClick={() => setActiveChatId(chat.id)}
                                    className={`group p-3 rounded-xl cursor-pointer transition-all flex items-center gap-3 relative ${activeChatId === chat.id ? 'bg-indigo-500/10 border border-indigo-500/20' : 'hover:bg-slate-800/50 border border-transparent'}`}
                                >
                                    <div className="relative">
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-slate-300 font-bold border border-slate-600">
                                            {chat.name.charAt(0)}
                                        </div>
                                        {/* Online Indicator */}
                                        {onlineStatus[chat.id] && (
                                            <div className="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 rounded-full border-2 border-slate-900"></div>
                                        )}
                                    </div>
                                    
                                    {sidebarOpen && (
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-center">
                                                <h4 className="font-medium text-slate-200 truncate">{chat.name}</h4>
                                                {chat.messages.length > 0 && <span className="text-[10px] text-slate-500">{formatTime(chat.messages[chat.messages.length-1].timestamp)}</span>}
                                            </div>
                                            <div className="text-xs text-slate-500 truncate h-4">
                                                {typingStatus[chat.id] ? <span className="text-indigo-400 font-medium">Typing...</span> : (chat.messages[chat.messages.length-1]?.text || (chat.messages[chat.messages.length-1]?.image ? "üì∑ Image" : "No messages"))}
                                            </div>
                                        </div>
                                    )}
                                    {chat.unread > 0 && sidebarOpen && (
                                        <div className="w-5 h-5 bg-indigo-500 rounded-full flex items-center justify-center text-[10px] font-bold text-white shadow-lg shadow-indigo-500/40">
                                            {chat.unread}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* User Profile / Settings */}
                        <div className="p-4 border-t border-slate-800 bg-slate-900/50">
                            {isSettingsOpen ? (
                                <div className="space-y-2 animate-fade-in">
                                    <input 
                                        type="text" 
                                        value={myProfile.name}
                                        onChange={(e) => setMyProfile({...myProfile, name: e.target.value})}
                                        className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm"
                                        placeholder="Display Name"
                                    />
                                    <div className="flex gap-2">
                                        <button onClick={updateProfile} className="flex-1 bg-emerald-600 text-xs py-1 rounded">Save</button>
                                        <button onClick={() => setIsSettingsOpen(false)} className="flex-1 bg-slate-700 text-xs py-1 rounded">Cancel</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center font-bold">{myProfile.name.charAt(0)}</div>
                                    {sidebarOpen && (
                                        <div className="flex-1 min-w-0">
                                            <div className="text-sm font-bold truncate">{myProfile.name}</div>
                                            <div className="text-[10px] text-slate-500 truncate cursor-pointer hover:text-indigo-400 flex items-center gap-1" onClick={() => {navigator.clipboard.writeText(myPeerId); alert("ID Copied!");}}>
                                                ID: {myPeerId ? myPeerId.substr(0,8) + "..." : "Loading..."} <i data-lucide="copy" className="w-3 h-3"></i>
                                            </div>
                                        </div>
                                    )}
                                    {sidebarOpen && (
                                        <button onClick={() => setIsSettingsOpen(true)} className="p-1 hover:text-white text-slate-500">
                                            <i data-lucide="settings" className="w-4 h-4"></i>
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Chat Area */}
                    <div className="flex-1 flex flex-col relative z-10">
                        {!sidebarOpen && (
                            <button onClick={() => setSidebarOpen(true)} className="md:hidden absolute top-4 left-4 z-20 p-2 bg-slate-800 rounded-lg shadow-lg">
                                <i data-lucide="menu"></i>
                            </button>
                        )}

                        {activeChatId ? (
                            <>
                                {/* Chat Header */}
                                <div className="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/80 backdrop-blur glass-morphism">
                                    <div className="flex items-center gap-4 pl-8 md:pl-0">
                                        <div className="relative">
                                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg">
                                                {chats[activeChatId].name.charAt(0)}
                                            </div>
                                            {onlineStatus[activeChatId] && <div className="absolute bottom-0 right-0 w-3 h-3 bg-emerald-400 rounded-full border-2 border-slate-900"></div>}
                                        </div>
                                        <div>
                                            <h2 className="font-bold text-white flex items-center gap-2">
                                                {chats[activeChatId].name}
                                                <button onClick={() => setActiveModal('rename')} className="text-slate-600 hover:text-indigo-400"><i data-lucide="edit-2" className="w-3 h-3"></i></button>
                                            </h2>
                                            <div className="text-xs text-slate-400">
                                                {typingStatus[activeChatId] ? "typing..." : (onlineStatus[activeChatId] ? "Online" : "Offline")}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <button className="p-2 hover:bg-slate-800 rounded-full text-slate-400"><i data-lucide="phone"></i></button>
                                        <button className="p-2 hover:bg-slate-800 rounded-full text-slate-400"><i data-lucide="video"></i></button>
                                        <div className="h-6 w-px bg-slate-700 mx-2"></div>
                                        <button onClick={() => {
                                             if(confirm("Delete chat history?")) {
                                                 setChats(prev => { const n = {...prev}; delete n[activeChatId]; return n; });
                                                 setActiveChatId(null);
                                             }
                                        }} className="p-2 hover:bg-red-900/30 hover:text-red-400 rounded-full text-slate-400 transition-colors"><i data-lucide="trash-2"></i></button>
                                    </div>
                                </div>

                                {/* Messages Container */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-6">
                                    {chats[activeChatId].messages.map((msg, i) => (
                                        <div key={msg.id || i} className={`flex ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`message-bubble flex flex-col ${msg.sender === 'me' ? 'items-end' : 'items-start'}`}>
                                                <div className={`px-4 py-3 rounded-2xl shadow-md text-sm ${
                                                    msg.sender === 'me' 
                                                    ? 'bg-indigo-600 text-white rounded-tr-none' 
                                                    : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-tl-none'
                                                }`}>
                                                    {msg.image && (
                                                        <img src={msg.image} alt="shared" className="max-w-full rounded-lg mb-2 max-h-64 object-cover border border-white/10" />
                                                    )}
                                                    {msg.text}
                                                </div>
                                                <span className="text-[10px] text-slate-500 mt-1 px-1">{formatTime(msg.timestamp)}</span>
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Input Area */}
                                <div className="p-4 bg-slate-900/50 backdrop-blur border-t border-slate-800">
                                    <div className="max-w-4xl mx-auto flex gap-3 items-end">
                                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                                        <button onClick={() => fileInputRef.current.click()} className="p-3 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-indigo-400 rounded-xl transition-colors border border-slate-700">
                                            <i data-lucide="image" className="w-5 h-5"></i>
                                        </button>
                                        <div className="flex-1 bg-slate-950 border border-slate-700 rounded-xl flex items-center px-4 focus-within:border-indigo-500 focus-within:ring-1 focus-within:ring-indigo-500 transition-all">
                                            <input 
                                                type="text" 
                                                value={msgInput}
                                                onChange={handleTyping}
                                                onKeyDown={(e) => e.key === 'Enter' && sendMessage(msgInput)}
                                                placeholder="Type an encrypted message..." 
                                                className="w-full bg-transparent border-none py-3 focus:outline-none text-slate-200"
                                            />
                                        </div>
                                        <button 
                                            onClick={() => sendMessage(msgInput)}
                                            className="p-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl shadow-lg shadow-indigo-500/20 transition-all transform active:scale-95"
                                        >
                                            <i data-lucide="send" className="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center p-8 text-center bg-slate-900/30">
                                <div className="w-32 h-32 bg-slate-800/50 rounded-full flex items-center justify-center mb-6 relative">
                                    <div className="absolute inset-0 border-2 border-indigo-500/20 rounded-full animate-ping"></div>
                                    <i data-lucide="message-square" className="w-12 h-12 text-indigo-400"></i>
                                </div>
                                <h1 className="text-3xl font-bold text-white mb-2">Welcome to QuantumChat Pro</h1>
                                <p className="text-slate-400 max-w-md mb-8">
                                    Secure, peer-to-peer messaging with no middleman. 
                                    Your data never leaves your device's local storage.
                                </p>
                                <button onClick={() => setActiveModal('add')} className="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-full font-medium transition-all shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50">
                                    Start a Conversation
                                </button>
                            </div>
                        )}
                    </div>

                    {renderModal()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>


